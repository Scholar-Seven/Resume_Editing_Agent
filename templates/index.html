<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>æ™ºèƒ½ç®€å†ä¼˜åŒ–åŠ©æ‰‹</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
      background: #f7f8fa;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 900px;
      margin: 30px auto;
      background: #fff;
      padding: 24px;
      border-radius: 8px;
      box-shadow: 0 6px 20px rgba(0,0,0,.06);
    }
    h1 { margin-top: 0; }
    textarea {
      width: 100%;
      min-height: 120px;
      resize: vertical;
      padding: 10px;
      box-sizing: border-box;
    }
    .section { margin-bottom: 24px; }
    .btn {
      display: inline-block;
      padding: 10px 16px;
      background: #1677ff;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    .btn:disabled { background: #999; cursor: not-allowed; }
    .suggestion {
      border: 1px solid #e5e6eb;
      padding: 12px;
      margin-bottom: 12px;
      border-radius: 8px;
    }
    .suggestion h4 { margin: 0 0 6px; }
    .tag {
      display: inline-block;
      padding: 2px 8px;
      font-size: 12px;
      border-radius: 6px;
      background: #f0f0f0;
      margin-right: 6px;
    }
    .P0 { background: #ffccc7; }
    .P1 { background: #fff1b8; }
    .P2 { background: #e6f4ff; }
    .hidden { display: none; }
    .footer { color: #999; font-size: 13px; margin-top: 30px; text-align: center; }

    /* âœ… Loading overlay */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .overlay-card {
      background: #fff;
      border-radius: 12px;
      padding: 18px 20px;
      width: 320px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      text-align: center;
    }
    .spinner {
      width: 28px;
      height: 28px;
      border: 3px solid #ddd;
      border-top-color: #1677ff;
      border-radius: 50%;
      margin: 10px auto 12px;
      animation: spin 0.9s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .hint {
      color: #666;
      font-size: 13px;
      margin-top: 8px;
      line-height: 1.4;
    }

    .error {
      background: #fff2f0;
      border: 1px solid #ffccc7;
      color: #a8071a;
      padding: 10px 12px;
      border-radius: 8px;
      margin-top: 10px;
    }
  </style>
</head>
<body>

<!-- âœ… Loading overlay -->
<div id="loadingOverlay" class="overlay" style="display:none" aria-live="polite" aria-busy="true">
  <div class="overlay-card">
    <div style="font-weight: 600;">åˆ†æä¸­â€¦</div>
    <div class="spinner"></div>
    <div class="hint" id="loadingHint">æ­£åœ¨ä¸Šä¼ ç®€å†å¹¶è§£æå†…å®¹</div>
  </div>
</div>

<div class="container">
  <h1>ğŸ“„ æ™ºèƒ½ç®€å†ä¼˜åŒ–åŠ©æ‰‹</h1>

  <!-- STEP 1: Upload -->
  <div class="section">
    <h3>1ï¸âƒ£ ä¸Šä¼ ç®€å† & å¡«å†™èŒä½æè¿°ï¼ˆJDï¼‰</h3>
    <input type="file" id="resumeFile" accept=".pdf,.doc,.docx" />
    <br /><br />
    <textarea id="jdText" placeholder="è¯·ç²˜è´´èŒä½æè¿°ï¼ˆJDï¼‰..."></textarea>
    <br /><br />
    <button class="btn" id="btnUploadAnalyze" onclick="uploadResume()">ä¸Šä¼ å¹¶åˆ†æ</button>
    <div id="errorBox" class="error hidden"></div>
  </div>

  <!-- STEP 2: Analysis -->
  <div class="section hidden" id="analysisSection">
    <h3>2ï¸âƒ£ åŒ¹é…åˆ†æç»“æœ</h3>
    <p><strong>åŒ¹é…åº¦ï¼š</strong><span id="matchScore"></span> % </p>

    <h4>ä¼˜åŠ¿</h4>
    <ul id="strengthList"></ul>

    <h4>ä¸è¶³</h4>
    <ul id="gapList"></ul>

    <h4>ä¼˜åŒ–å»ºè®®ï¼ˆå¯é€‰æ‹©ï¼‰</h4>
    <div id="suggestionList"></div>

    <button class="btn" id="btnConfirmOptimize" onclick="confirmSuggestions()">ç¡®è®¤å¹¶ç”Ÿæˆä¼˜åŒ–ç®€å†</button>
  </div>

  <!-- STEP 3: Result -->
  <div class="section hidden" id="resultSection">
    <h3>3ï¸âƒ£ ä¼˜åŒ–å®Œæˆ ğŸ‰</h3>
    <p>ä½ çš„ç®€å†å·²æ ¹æ®ç¡®è®¤çš„å»ºè®®å®Œæˆä¼˜åŒ–ã€‚</p>
    <a id="downloadLink" class="btn" href="#" target="_blank">ä¸‹è½½ä¼˜åŒ–åçš„ç®€å†ï¼ˆdocxï¼‰</a>
  </div>

  <div class="footer">
    Powered by LangChain + DeepSeek + Flask
  </div>
</div>

<script>
  let resumeId = null;

  // âœ… UI helpers
  function showLoading(message) {
    document.getElementById("loadingHint").innerText = message || "å¤„ç†ä¸­â€¦";
    document.getElementById("loadingOverlay").style.display = "flex";
  }

  function hideLoading() {
    document.getElementById("loadingOverlay").style.display = "none";
  }
  function setError(msg) {
    const box = document.getElementById("errorBox");
    if (!msg) {
      box.classList.add("hidden");
      box.innerText = "";
      return;
    }
    box.classList.remove("hidden");
    box.innerText = msg;
  }

  // âœ… 1) æ¸…ç©ºä¸Šä¸€æ¬¡åˆ†æå†…å®¹
  function resetPreviousResults() {
    // æ¸…ç©º error
    setError("");

    // éšè—åˆ†æ/ç»“æœåŒº
    document.getElementById("analysisSection").classList.add("hidden");
    document.getElementById("resultSection").classList.add("hidden");

    // æ¸…ç©ºåˆ†æå†…å®¹
    document.getElementById("matchScore").innerText = "";
    document.getElementById("strengthList").innerHTML = "";
    document.getElementById("gapList").innerHTML = "";
    document.getElementById("suggestionList").innerHTML = "";

    // æ¸…ç©ºä¸‹è½½é“¾æ¥
    const link = document.getElementById("downloadLink");
    link.href = "#";
  }

  function setButtonsDisabled(disabled) {
    document.getElementById("btnUploadAnalyze").disabled = disabled;
    document.getElementById("btnConfirmOptimize").disabled = disabled;
  }

  // âœ… fetch wrapper: ç»Ÿä¸€é”™è¯¯å¤„ç†
  async function fetchJSON(url, options) {
    const resp = await fetch(url, options);
    let data = null;
    try { data = await resp.json(); } catch(e) {}
    if (!resp.ok) {
      const msg = (data && (data.error || data.detail)) ? (data.error + (data.detail ? (": " + data.detail) : "")) : `è¯·æ±‚å¤±è´¥: ${resp.status}`;
      throw new Error(msg);
    }
    return data;
  }

  async function uploadResume() {
    // âœ… æ¸…ç©ºæ—§ç»“æœï¼ˆä½ çš„éœ€æ±‚ 1ï¼‰
    resetPreviousResults();

    const fileInput = document.getElementById("resumeFile");
    const jdText = document.getElementById("jdText").value.trim();

    if (!fileInput.files.length || !jdText) {
      setError("è¯·ä¸Šä¼ ç®€å†æ–‡ä»¶å¹¶å¡«å†™ JDã€‚");
      return;
    }

    const formData = new FormData();
    formData.append("resume_file", fileInput.files[0]);
    formData.append("jd_text", jdText);

    setButtonsDisabled(true);
    showLoading("æ­£åœ¨ä¸Šä¼ ç®€å†å¹¶è§£æå†…å®¹â€¦"); // âœ… ä½ çš„éœ€æ±‚ 2

    try {
      const uploadData = await fetchJSON("/upload", {
        method: "POST",
        body: formData
      });

      resumeId = uploadData.resume_id;

      showLoading("æ­£åœ¨åˆ†æç®€å†ä¸ JD çš„åŒ¹é…åº¦â€¦");
      await analyzeResume();

    } catch (err) {
      setError(err.message || "ä¸Šä¼ /åˆ†æå¤±è´¥ï¼Œè¯·é‡è¯•ã€‚");
    } finally {
      hideLoading();
      setButtonsDisabled(false);
    }
  }

  async function analyzeResume() {
    const data = await fetchJSON("/analyze", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ resume_id: resumeId })
    });

    // å±•ç¤ºåˆ†æåŒº
    document.getElementById("analysisSection").classList.remove("hidden");

    document.getElementById("matchScore").innerText = data.overall_score ?? "";

    renderList("strengthList", data.strengths || []);
    renderList("gapList", data.gaps || []);
    renderSuggestions(data.suggestions || []);
  }

  function renderList(id, items) {
    const ul = document.getElementById(id);
    ul.innerHTML = "";
    items.forEach(t => {
      const li = document.createElement("li");
      li.innerText = t;
      ul.appendChild(li);
    });
  }

  function escapeHtml(s) {
    return String(s)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function renderSuggestions(suggestions) {
    const container = document.getElementById("suggestionList");
    container.innerHTML = "";

    suggestions.forEach(s => {
      const div = document.createElement("div");
      div.className = "suggestion";

      const issue = escapeHtml(s.issue || "");
      const rec = escapeHtml(s.recommendation || "");
      const ev = s.evidence ? `<p><strong>ä¾æ®ï¼š</strong>${escapeHtml(s.evidence)}</p>` : "";

      div.innerHTML = `
        <label>
          <input type="checkbox" value="${escapeHtml(s.id)}" checked />
          <strong>${issue}</strong>
        </label>
        <div style="margin-top:6px">
          <span class="tag ${escapeHtml(s.priority || "P2")}">${escapeHtml(s.priority || "P2")}</span>
          <span class="tag">${escapeHtml(s.target_section || "")}</span>
        </div>
        <p><strong>å»ºè®®ï¼š</strong>${rec}</p>
        ${ev}
      `;
      container.appendChild(div);
    });
  }

  async function confirmSuggestions() {
    setError("");

    const checked = Array.from(
      document.querySelectorAll("#suggestionList input:checked")
    ).map(i => i.value);

    if (!checked.length) {
      setError("è¯·è‡³å°‘é€‰æ‹©ä¸€æ¡ä¼˜åŒ–å»ºè®®ã€‚");
      return;
    }

    setButtonsDisabled(true);
    showLoading("æ­£åœ¨ç”Ÿæˆä¼˜åŒ–åçš„ç®€å†æ–‡ä»¶â€¦");

    try {
      await fetchJSON("/confirm", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          resume_id: resumeId,
          confirmed_suggestion_ids: checked
        })
      });

      const result = await fetchJSON("/optimize", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ resume_id: resumeId })
      });

      document.getElementById("resultSection").classList.remove("hidden");
      const link = document.getElementById("downloadLink");
      link.href = result.download_url;

    } catch (err) {
      setError(err.message || "ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•ã€‚");
    } finally {
      hideLoading();
      setButtonsDisabled(false);
    }
  }
</script>

</body>
</html>
